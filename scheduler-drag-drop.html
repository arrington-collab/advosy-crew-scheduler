<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drag & Drop Scheduler - Advosy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); min-height: 100vh; }
        .glass { background: rgba(255,255,255,0.03); backdrop-filter: blur(10px); }
        .job-card { cursor: grab; transition: all 0.2s; }
        .job-card:active { cursor: grabbing; }
        .job-card.dragging { opacity: 0.5; transform: scale(1.05); }
        .drop-zone { min-height: 100px; transition: all 0.2s; }
        .drop-zone.drag-over { background: rgba(249, 115, 22, 0.2); border-color: #f97316; }
        .crew-column { min-width: 280px; max-width: 320px; }
        .date-row { scroll-snap-type: x mandatory; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .unassigned-zone { background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3); }
    </style>
</head>
<body class="text-white p-6">
    <!-- Header -->
    <header class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-4">
            <a href="dashboard-live.html" class="text-slate-400 hover:text-white">‚Üê Back to Dashboard</a>
            <h1 class="text-2xl font-bold">üìÖ Drag & Drop Scheduler</h1>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="previousWeek()" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg">‚Üê Prev</button>
            <span id="week-label" class="text-lg font-semibold px-4">Loading...</span>
            <button onclick="nextWeek()" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg">Next ‚Üí</button>
            <button onclick="goToToday()" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 rounded-lg font-semibold">Today</button>
        </div>
    </header>

    <!-- Unassigned Jobs -->
    <div class="glass rounded-xl border border-red-500/30 p-4 mb-6 unassigned-zone">
        <h2 class="text-sm font-semibold text-red-400 mb-3">üì¶ UNASSIGNED JOBS (<span id="unassigned-count">0</span>)</h2>
        <div id="unassigned-jobs" class="flex gap-3 overflow-x-auto pb-2 scrollbar-hide">
            <p class="text-slate-500 text-sm">Loading...</p>
        </div>
    </div>

    <!-- Schedule Grid -->
    <div class="glass rounded-xl border border-white/10 p-4 overflow-hidden">
        <!-- Crew Headers -->
        <div class="flex gap-4 mb-4 overflow-x-auto scrollbar-hide" id="crew-headers">
            <div class="w-24 flex-shrink-0"></div>
            <!-- Crew columns will be inserted here -->
        </div>

        <!-- Days -->
        <div id="schedule-grid" class="space-y-2 overflow-y-auto" style="max-height: calc(100vh - 350px);">
            <p class="text-slate-500 text-center py-8">Loading schedule...</p>
        </div>
    </div>

    <!-- Legend -->
    <div class="flex gap-6 mt-4 text-xs text-slate-400">
        <span>üí° Drag jobs between crews or dates</span>
        <span>üî¥ Red border = needs attention</span>
        <span>üü¢ Green = all tasks complete</span>
    </div>

    <script>
        const CONFIG = {
            jobsSheetUrl: 'https://docs.google.com/spreadsheets/d/1msoAfjZr2C8_PcpHL7hn4qv2rzgVPF4EsjAhPaIlcb8/gviz/tq?tqx=out:json&sheet=Jobs',
            tasksSheetUrl: 'https://docs.google.com/spreadsheets/d/1msoAfjZr2C8_PcpHL7hn4qv2rzgVPF4EsjAhPaIlcb8/gviz/tq?tqx=out:json&sheet=Job_Tasks',
            crewsSheetUrl: 'https://docs.google.com/spreadsheets/d/1msoAfjZr2C8_PcpHL7hn4qv2rzgVPF4EsjAhPaIlcb8/gviz/tq?tqx=out:json&sheet=Crews',
            updateUrl: 'https://banc-r.app.n8n.cloud/webhook/update-task'
        };

        let allJobs = [];
        let allTasks = {};
        let allCrews = {};
        let currentWeekStart = getMonday(new Date());
        let draggedJob = null;

        function getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            d.setDate(diff);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function previousWeek() {
            currentWeekStart.setDate(currentWeekStart.getDate() - 7);
            renderSchedule();
        }

        function nextWeek() {
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            renderSchedule();
        }

        function goToToday() {
            currentWeekStart = getMonday(new Date());
            renderSchedule();
        }

        async function loadData() {
            try {
                await Promise.all([loadJobs(), loadTasks(), loadCrews()]);
                renderSchedule();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        async function loadJobs() {
            const response = await fetch(CONFIG.jobsSheetUrl);
            const text = await response.text();
            const jsonString = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);?/)[1];
            const data = JSON.parse(jsonString);
            const rows = data.table.rows;
            const cols = data.table.cols.map(c => c.label);

            allJobs = rows.map(row => {
                const obj = {};
                row.c.forEach((cell, i) => {
                    if (cols[i]) obj[cols[i]] = cell ? (cell.v !== null ? cell.v : '') : '';
                });
                return obj;
            }).filter(job => job.job_id && job.status !== 'Completed');
        }

        async function loadTasks() {
            const response = await fetch(CONFIG.tasksSheetUrl);
            const text = await response.text();
            const jsonString = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);?/)[1];
            const data = JSON.parse(jsonString);
            const rows = data.table.rows;
            const cols = data.table.cols.map(c => c.label);

            allTasks = {};
            rows.forEach(row => {
                const obj = {};
                row.c.forEach((cell, i) => {
                    if (cols[i]) obj[cols[i]] = cell ? cell.v : null;
                });
                if (obj.job_id) allTasks[obj.job_id] = obj;
            });
        }

        async function loadCrews() {
            const response = await fetch(CONFIG.crewsSheetUrl);
            const text = await response.text();
            const jsonString = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);?/)[1];
            const data = JSON.parse(jsonString);
            const rows = data.table.rows;
            const cols = data.table.cols.map(c => c.label);

            allCrews = {};
            rows.forEach(row => {
                const obj = {};
                row.c.forEach((cell, i) => {
                    if (cols[i]) obj[cols[i]] = cell ? cell.v : null;
                });
                if (obj.crew_id && obj.crew_name && (obj.active === 'TRUE' || obj.active === true)) {
                    allCrews[obj.crew_id] = obj;
                }
            });
        }

        function renderSchedule() {
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            document.getElementById('week-label').textContent = 
                `${currentWeekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;

            const crewIds = Object.keys(allCrews).sort();
            
            // Render crew headers
            document.getElementById('crew-headers').innerHTML = `
                <div class="w-24 flex-shrink-0"></div>
                ${crewIds.map(crewId => `
                    <div class="crew-column flex-shrink-0 text-center">
                        <div class="bg-orange-500/20 border border-orange-500/30 rounded-lg p-2">
                            <p class="font-bold text-orange-400">${allCrews[crewId].crew_name}</p>
                        </div>
                    </div>
                `).join('')}
            `;

            // Render unassigned jobs
            const unassigned = allJobs.filter(j => !j.crew_id || j.crew_id === '');
            document.getElementById('unassigned-count').textContent = unassigned.length;
            document.getElementById('unassigned-jobs').innerHTML = unassigned.length > 0 
                ? unassigned.map(job => renderJobCard(job)).join('')
                : '<p class="text-slate-500 text-sm">No unassigned jobs</p>';

            // Render days
            let gridHtml = '';
            for (let i = 0; i < 7; i++) {
                const date = new Date(currentWeekStart);
                date.setDate(date.getDate() + i);
                const dateStr = formatDate(date);
                const isToday = dateStr === formatDate(new Date());
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                const dayNum = date.getDate();

                gridHtml += `
                    <div class="flex gap-4 ${isToday ? 'bg-orange-500/10 rounded-lg' : ''}">
                        <div class="w-24 flex-shrink-0 p-2 text-center">
                            <p class="text-xs text-slate-400">${dayName}</p>
                            <p class="text-2xl font-bold ${isToday ? 'text-orange-400' : 'text-white'}">${dayNum}</p>
                        </div>
                        ${crewIds.map(crewId => {
                            const dayJobs = allJobs.filter(j => j.scheduled_date === dateStr && j.crew_id === crewId);
                            const totalSq = dayJobs.reduce((sum, j) => sum + (parseFloat(j.squares) || 0), 0);
                            return `
                                <div class="crew-column flex-shrink-0 drop-zone border border-dashed border-slate-600 rounded-lg p-2 min-h-[80px]"
                                     data-date="${dateStr}" data-crew="${crewId}"
                                     ondragover="handleDragOver(event)" 
                                     ondragleave="handleDragLeave(event)"
                                     ondrop="handleDrop(event)">
                                    ${dayJobs.length > 0 ? `
                                        <div class="text-xs text-slate-400 mb-2">${dayJobs.length} jobs ‚Ä¢ ${Math.round(totalSq)} SQ</div>
                                        ${dayJobs.map(job => renderJobCard(job)).join('')}
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }
            document.getElementById('schedule-grid').innerHTML = gridHtml;

            // Add drag listeners to all job cards
            document.querySelectorAll('.job-card').forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
            });
        }

        function renderJobCard(job) {
            const tasks = allTasks[job.job_id] || {};
            const allTasksDone = 
                (tasks.material_ordered === 'TRUE' || tasks.material_ordered === true) &&
                (tasks.ho_notified === 'TRUE' || tasks.ho_notified === true) &&
                (tasks.sub_accepted === 'TRUE' || tasks.sub_accepted === true) &&
                (tasks.work_order_sent === 'TRUE' || tasks.work_order_sent === true);
            
            const needsAttention = !allTasksDone && job.scheduled_date;
            const borderClass = allTasksDone ? 'border-green-500/50' : (needsAttention ? 'border-red-500/50' : 'border-slate-600');

            return `
                <div class="job-card bg-slate-800 rounded-lg p-2 mb-2 border ${borderClass}" 
                     draggable="true" 
                     data-job-id="${job.job_id}"
                     data-job='${JSON.stringify(job).replace(/'/g, "\\'")}'>
                    <p class="font-semibold text-sm text-white truncate">${job.customer_name}</p>
                    <p class="text-xs text-slate-400 truncate">${job.address || ''}</p>
                    <div class="flex justify-between items-center mt-1">
                        <span class="text-orange-400 font-bold text-sm">${job.squares} SQ</span>
                        <span class="text-green-400 text-xs">$${parseFloat(job.crew_total_pay || 0).toLocaleString()}</span>
                    </div>
                </div>
            `;
        }

        function handleDragStart(e) {
            draggedJob = JSON.parse(e.target.dataset.job.replace(/\\'/g, "'"));
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.drop-zone').forEach(zone => zone.classList.remove('drag-over'));
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        async function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            
            if (!draggedJob) return;

            const newDate = e.currentTarget.dataset.date;
            const newCrew = e.currentTarget.dataset.crew;

            // Check if anything changed
            if (draggedJob.scheduled_date === newDate && draggedJob.crew_id === newCrew) {
                draggedJob = null;
                return;
            }

            // Update job
            try {
                const updates = {
                    action: 'reschedule_and_assign',
                    job_id: draggedJob.job_id,
                    scheduled_date: newDate,
                    crew_id: newCrew
                };

                const response = await fetch(CONFIG.updateUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates)
                });

                if (response.ok) {
                    // Update local data
                    const jobIndex = allJobs.findIndex(j => j.job_id === draggedJob.job_id);
                    if (jobIndex >= 0) {
                        allJobs[jobIndex].scheduled_date = newDate;
                        allJobs[jobIndex].crew_id = newCrew;
                    }
                    renderSchedule();
                } else {
                    alert('Failed to update job. Please try again.');
                }
            } catch (error) {
                console.error('Error updating job:', error);
                alert('Failed to update job. Please try again.');
            }

            draggedJob = null;
        }

        // Initialize
        loadData();
    </script>
</body>
</html>
