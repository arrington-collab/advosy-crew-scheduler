<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Dispatch Sheet - Advosy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            body { 
                background: white !important; 
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .no-print { display: none !important; }
            .print-break { page-break-before: always; }
            .job-card { break-inside: avoid; }
        }
        body { font-family: 'Segoe UI', sans-serif; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">
    <!-- Controls (hidden when printing) -->
    <div class="no-print bg-slate-800 text-white p-4 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="dashboard-live.html" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm flex items-center gap-2">
                    ‚Üê Dashboard
                </a>
                <h1 class="text-xl font-bold">üìã Daily Dispatch Sheet</h1>
                <input type="date" id="dispatch-date" class="px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white">
                <button onclick="loadDispatch()" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 rounded-lg font-semibold">Load</button>
            </div>
            <div class="flex items-center gap-2">
                <select id="crew-filter" onchange="applyCrewFilter()" class="px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white">
                    <option value="all">All Crews</option>
                </select>
                <button onclick="window.print()" class="px-4 py-2 bg-green-500 hover:bg-green-600 rounded-lg font-semibold flex items-center gap-2">
                    üñ®Ô∏è Print / Save PDF
                </button>
            </div>
        </div>
    </div>

    <!-- Dispatch Content -->
    <div id="dispatch-content" class="max-w-6xl mx-auto p-6">
        <!-- Header -->
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-slate-800">ADVOSY CONSTRUCTION</h1>
            <h2 class="text-xl text-slate-600">Daily Dispatch Sheet</h2>
            <p class="text-lg font-semibold text-orange-600 mt-2" id="dispatch-date-display">Loading...</p>
        </div>

        <!-- Summary Stats -->
        <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-lg p-4 text-center shadow">
                <p class="text-3xl font-bold text-orange-500" id="stat-jobs">0</p>
                <p class="text-sm text-slate-500">Total Jobs</p>
            </div>
            <div class="bg-white rounded-lg p-4 text-center shadow">
                <p class="text-3xl font-bold text-blue-500" id="stat-squares">0</p>
                <p class="text-sm text-slate-500">Total Squares</p>
            </div>
            <div class="bg-white rounded-lg p-4 text-center shadow">
                <p class="text-3xl font-bold text-green-500" id="stat-crews">0</p>
                <p class="text-sm text-slate-500">Crews Working</p>
            </div>
            <div class="bg-white rounded-lg p-4 text-center shadow">
                <p class="text-3xl font-bold text-purple-500" id="stat-pay">$0</p>
                <p class="text-sm text-slate-500">Total Crew Pay</p>
            </div>
        </div>

        <!-- Jobs by Crew -->
        <div id="jobs-by-crew">
            <p class="text-slate-500 text-center py-8">Select a date and click Load</p>
        </div>
    </div>

    <script>
        const CONFIG = {
            jobsSheetUrl: 'https://docs.google.com/spreadsheets/d/1msoAfjZr2C8_PcpHL7hn4qv2rzgVPF4EsjAhPaIlcb8/gviz/tq?tqx=out:json&sheet=Jobs',
            tasksSheetUrl: 'https://docs.google.com/spreadsheets/d/1msoAfjZr2C8_PcpHL7hn4qv2rzgVPF4EsjAhPaIlcb8/gviz/tq?tqx=out:json&sheet=Job_Tasks',
            crewsSheetUrl: 'https://docs.google.com/spreadsheets/d/1msoAfjZr2C8_PcpHL7hn4qv2rzgVPF4EsjAhPaIlcb8/gviz/tq?tqx=out:json&sheet=Crews'
        };

        let allJobs = [];
        let allTasks = {};
        let allCrews = {};

        // Set default date to today
        document.getElementById('dispatch-date').valueAsDate = new Date();

        async function loadDispatch() {
            const dateInput = document.getElementById('dispatch-date').value;
            if (!dateInput) {
                alert('Please select a date');
                return;
            }

            document.getElementById('jobs-by-crew').innerHTML = '<p class="text-slate-500 text-center py-8">Loading...</p>';

            try {
                // Load all data
                await Promise.all([loadJobs(), loadTasks(), loadCrews()]);

                console.log('All jobs loaded:', allJobs.length);
                console.log('Sample job:', allJobs[0]);
                console.log('Looking for date:', dateInput);
                console.log('Jobs with dates:', allJobs.map(j => ({ name: j.customer_name, date: j.scheduled_date })).slice(0, 5));

                // Filter jobs for selected date
                const selectedDate = dateInput;
                const dayJobs = allJobs.filter(job => {
                    // Try multiple date formats
                    const jobDate = job.scheduled_date;
                    if (!jobDate) return false;
                    
                    // Direct match
                    if (jobDate === selectedDate) return true;
                    
                    // Try parsing as date and comparing
                    try {
                        const jobDateParsed = new Date(jobDate + 'T00:00:00');
                        const selectedDateParsed = new Date(selectedDate + 'T00:00:00');
                        return jobDateParsed.getTime() === selectedDateParsed.getTime();
                    } catch (e) {
                        return false;
                    }
                });
                
                console.log('Jobs found for date:', dayJobs.length);
                
                // Store for crew filtering
                currentDayJobs = dayJobs;

                // Apply crew filter
                const crewFilter = document.getElementById('crew-filter').value;
                const filteredJobs = crewFilter === 'all' ? dayJobs : dayJobs.filter(j => j.crew_id === crewFilter);

                // Update display
                renderDispatch(filteredJobs, selectedDate);

            } catch (error) {
                console.error('Error loading dispatch:', error);
                document.getElementById('jobs-by-crew').innerHTML = '<p class="text-red-500 text-center py-8">Error loading data: ' + error.message + '</p>';
            }
        }

        // Store the loaded day jobs for filtering
        let currentDayJobs = [];

        function applyCrewFilter() {
            const crewFilter = document.getElementById('crew-filter').value;
            const filteredJobs = crewFilter === 'all' ? currentDayJobs : currentDayJobs.filter(j => j.crew_id === crewFilter);
            const dateInput = document.getElementById('dispatch-date').value;
            renderDispatch(filteredJobs, dateInput);
        }

        async function loadJobs() {
            const response = await fetch(CONFIG.jobsSheetUrl);
            const text = await response.text();
            const jsonString = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);?/)[1];
            const data = JSON.parse(jsonString);
            const rows = data.table.rows;
            const cols = data.table.cols.map(c => c.label);

            allJobs = rows.map(row => {
                const obj = {};
                row.c.forEach((cell, i) => {
                    if (cols[i]) {
                        let value = cell ? cell.v : '';
                        // Handle Google Sheets date format: Date(year, month, day)
                        if (cell && cell.v && typeof cell.v === 'string' && cell.v.startsWith('Date(')) {
                            const match = cell.v.match(/Date\((\d+),(\d+),(\d+)\)/);
                            if (match) {
                                const year = match[1];
                                const month = String(parseInt(match[2]) + 1).padStart(2, '0');
                                const day = String(match[3]).padStart(2, '0');
                                value = `${year}-${month}-${day}`;
                            }
                        }
                        // Also check formatted value (f) which might be a string date
                        if (cols[i] === 'scheduled_date' && cell && cell.f) {
                            // Try to parse formatted date
                            const parsed = new Date(cell.f);
                            if (!isNaN(parsed.getTime())) {
                                value = parsed.toISOString().split('T')[0];
                            }
                        }
                        obj[cols[i]] = value !== null ? value : '';
                    }
                });
                return obj;
            }).filter(job => job.job_id);
            
            console.log('Loaded jobs:', allJobs.length, 'Sample:', allJobs[0]);
        }

        async function loadTasks() {
            const response = await fetch(CONFIG.tasksSheetUrl);
            const text = await response.text();
            const jsonString = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);?/)[1];
            const data = JSON.parse(jsonString);
            const rows = data.table.rows;
            const cols = data.table.cols.map(c => c.label);

            allTasks = {};
            rows.forEach(row => {
                const obj = {};
                row.c.forEach((cell, i) => {
                    if (cols[i]) {
                        obj[cols[i]] = cell ? cell.v : null;
                    }
                });
                if (obj.job_id) {
                    allTasks[obj.job_id] = obj;
                }
            });
        }

        async function loadCrews() {
            const response = await fetch(CONFIG.crewsSheetUrl);
            const text = await response.text();
            const jsonString = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);?/)[1];
            const data = JSON.parse(jsonString);
            const rows = data.table.rows;
            const cols = data.table.cols.map(c => c.label);

            allCrews = {};
            const crewSelect = document.getElementById('crew-filter');
            crewSelect.innerHTML = '<option value="all">All Crews</option>';

            rows.forEach(row => {
                const obj = {};
                row.c.forEach((cell, i) => {
                    if (cols[i]) {
                        obj[cols[i]] = cell ? cell.v : null;
                    }
                });
                if (obj.crew_id && obj.crew_name) {
                    allCrews[obj.crew_id] = obj;
                    crewSelect.innerHTML += `<option value="${obj.crew_id}">${obj.crew_name}</option>`;
                }
            });
        }

        function renderDispatch(jobs, dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            const dateFormatted = date.toLocaleDateString('en-US', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
            });
            document.getElementById('dispatch-date-display').textContent = dateFormatted;

            // Calculate stats
            const totalJobs = jobs.length;
            const totalSquares = jobs.reduce((sum, j) => sum + (parseFloat(j.squares) || 0), 0);
            const totalPay = jobs.reduce((sum, j) => sum + (parseFloat(j.crew_total_pay) || 0), 0);
            const crewsWorking = [...new Set(jobs.map(j => j.crew_id).filter(c => c))].length;

            document.getElementById('stat-jobs').textContent = totalJobs;
            document.getElementById('stat-squares').textContent = Math.round(totalSquares);
            document.getElementById('stat-crews').textContent = crewsWorking;
            document.getElementById('stat-pay').textContent = '$' + totalPay.toLocaleString();

            if (jobs.length === 0) {
                document.getElementById('jobs-by-crew').innerHTML = '<p class="text-slate-500 text-center py-8">No jobs scheduled for this date</p>';
                return;
            }

            // Group jobs by crew
            const jobsByCrew = {};
            jobs.forEach(job => {
                const crewId = job.crew_id || 'unassigned';
                if (!jobsByCrew[crewId]) {
                    jobsByCrew[crewId] = [];
                }
                jobsByCrew[crewId].push(job);
            });

            // Render each crew section
            let html = '';
            Object.keys(jobsByCrew).sort().forEach((crewId, index) => {
                const crewJobs = jobsByCrew[crewId];
                const crew = allCrews[crewId] || { crew_name: 'Unassigned', crew_lead_phone: '' };
                const crewSquares = crewJobs.reduce((sum, j) => sum + (parseFloat(j.squares) || 0), 0);
                const crewPay = crewJobs.reduce((sum, j) => sum + (parseFloat(j.crew_total_pay) || 0), 0);

                html += `
                    <div class="${index > 0 ? 'print-break' : ''} mb-8">
                        <div class="bg-orange-500 text-white p-4 rounded-t-lg flex justify-between items-center">
                            <div>
                                <h2 class="text-xl font-bold">${crew.crew_name}</h2>
                                <p class="text-orange-100">${crew.crew_lead_phone || 'No phone'}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-2xl font-bold">${crewJobs.length} Jobs</p>
                                <p class="text-orange-100">${Math.round(crewSquares)} SQ ‚Ä¢ $${crewPay.toLocaleString()}</p>
                            </div>
                        </div>
                        <div class="bg-white rounded-b-lg shadow">
                            ${crewJobs.map((job, i) => renderJobCard(job, i + 1)).join('')}
                        </div>
                    </div>
                `;
            });

            document.getElementById('jobs-by-crew').innerHTML = html;
        }

        function renderJobCard(job, index) {
            const tasks = allTasks[job.job_id] || {};
            const taskStatus = (key, label) => {
                const done = tasks[key] === 'TRUE' || tasks[key] === true;
                return `<span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-bold ${done ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                    ${done ? '‚úì' : '‚úó'} ${label}
                </span>`;
            };

            const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(job.address + ', ' + job.city + ', ' + job.state)}`;

            return `
                <div class="job-card p-4 border-b border-slate-200 last:border-b-0">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-start gap-3">
                            <span class="bg-slate-800 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">${index}</span>
                            <div>
                                <h3 class="font-bold text-lg text-slate-800">${job.customer_name}</h3>
                                <p class="text-slate-600">${job.address}</p>
                                <p class="text-slate-500 text-sm">${job.city}, ${job.state} ${job.zip || ''}</p>
                                <a href="${mapsUrl}" target="_blank" class="text-blue-500 text-sm no-print hover:underline">üìç Open in Maps</a>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold text-orange-500">${job.squares} <span class="text-sm text-slate-500">SQ</span></p>
                            <p class="text-green-600 font-semibold">$${parseFloat(job.crew_total_pay || 0).toLocaleString()}</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 mt-3 text-sm">
                        <div class="bg-slate-50 p-2 rounded">
                            <span class="text-slate-500">Shingle:</span>
                            <span class="font-semibold">${job.shingle_line || 'N/A'}</span>
                        </div>
                        <div class="bg-slate-50 p-2 rounded">
                            <span class="text-slate-500">Color:</span>
                            <span class="font-semibold">${job.shingle_color || 'N/A'}</span>
                        </div>
                    </div>

                    ${job.job_notes ? `
                        <div class="mt-2 p-2 bg-amber-50 border border-amber-200 rounded text-sm">
                            <span class="text-amber-700">üìù ${job.job_notes}</span>
                        </div>
                    ` : ''}

                    <div class="flex gap-2 mt-3 flex-wrap">
                        ${taskStatus('material_ordered', 'Material Ordered')}
                        ${taskStatus('ho_notified', 'HO Notified')}
                        ${taskStatus('material_delivered', 'Material Delivered')}
                        ${taskStatus('sub_accepted', 'Crew Accepted')}
                        ${taskStatus('work_order_sent', 'Work Order')}
                    </div>

                    ${job.customer_phone ? `
                        <div class="mt-3 pt-3 border-t border-slate-200 text-sm">
                            <span class="text-slate-500">Customer Phone:</span>
                            <a href="tel:${job.customer_phone}" class="font-semibold text-blue-600">${job.customer_phone}</a>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Auto-load on page load
        loadDispatch();
    </script>
</body>
</html>
