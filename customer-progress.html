<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Roof Installation Progress / Progreso de su Techo - Advosy Construction</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'DM Sans', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
            color: #1e293b;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Language Toggle */
        .lang-toggle {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .lang-btn {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 8px 16px;
            color: #64748b;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .lang-btn.active {
            background: #f97316;
            border-color: #f97316;
            color: white;
        }
        
        /* Header */
        .header {
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            color: white;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(249, 115, 22, 0.3);
        }
        .header .logo {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 5px;
        }
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        /* Job Info Card */
        .job-info {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }
        .job-info h2 {
            font-size: 20px;
            margin-bottom: 10px;
            color: #1e293b;
        }
        .job-info .address {
            color: #64748b;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .job-info .date {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e2e8f0;
            color: #f97316;
            font-weight: 600;
        }
        
        /* Progress Section */
        .progress-section {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }
        .progress-section h3 {
            font-size: 16px;
            color: #64748b;
            margin-bottom: 20px;
            text-align: center;
        }
        
        /* Progress Bar */
        .progress-bar-container {
            margin-bottom: 30px;
        }
        .progress-bar-bg {
            height: 12px;
            background: #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #16a34a);
            border-radius: 6px;
            transition: width 0.5s ease;
        }
        .progress-percentage {
            text-align: center;
            margin-top: 10px;
            font-size: 24px;
            font-weight: 700;
            color: #22c55e;
        }
        
        /* Progress Steps */
        .progress-steps {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .progress-step {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 12px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        .progress-step.completed {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(22, 163, 74, 0.1));
            border-color: #22c55e;
        }
        .progress-step.current {
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.1), rgba(234, 88, 12, 0.1));
            border-color: #f97316;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.2); }
            50% { box-shadow: 0 0 0 10px rgba(249, 115, 22, 0); }
        }
        .progress-step .icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .progress-step.completed .icon {
            background: #22c55e;
        }
        .progress-step.current .icon {
            background: #f97316;
        }
        .progress-step .content {
            flex: 1;
        }
        .progress-step .name {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 3px;
        }
        .progress-step .time {
            font-size: 13px;
            color: #64748b;
        }
        .progress-step.completed .time {
            color: #22c55e;
        }
        .progress-step .checkmark {
            color: #22c55e;
            font-size: 24px;
            font-weight: bold;
        }
        
        /* Photo Gallery */
        .photos-section {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }
        .photos-section h3 {
            font-size: 16px;
            color: #64748b;
            margin-bottom: 15px;
        }
        .photos-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .photo-item {
            border-radius: 12px;
            overflow: hidden;
            aspect-ratio: 1;
            background: #e2e8f0;
        }
        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .photo-item .placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
            font-size: 12px;
        }
        .photo-item .placeholder span {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        /* Contact Section */
        .contact-section {
            background: white;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }
        .contact-section h3 {
            font-size: 16px;
            color: #64748b;
            margin-bottom: 15px;
        }
        .contact-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 25px;
            background: linear-gradient(135deg, #f97316, #ea580c);
            color: white;
            border-radius: 12px;
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(249, 115, 22, 0.3);
        }
        
        /* Loading State */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }
        .loading .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top-color: #f97316;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Completed Banner */
        .completed-banner {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            text-align: center;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
        }
        .completed-banner .emoji {
            font-size: 48px;
            margin-bottom: 10px;
        }
        .completed-banner h2 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        .completed-banner p {
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Language Toggle -->
        <div class="lang-toggle">
            <button class="lang-btn active" onclick="setLanguage('en')">English</button>
            <button class="lang-btn" onclick="setLanguage('es')">Espa√±ol</button>
        </div>

        <!-- Header -->
        <div class="header">
            <div class="logo">Advosy Construction</div>
            <p data-en="Your Roof Installation Progress" data-es="Progreso de Instalaci√≥n de su Techo">Your Roof Installation Progress</p>
        </div>

        <!-- Loading State -->
        <div class="loading" id="loading-state">
            <div class="spinner"></div>
            <p data-en="Loading your project status..." data-es="Cargando el estado de su proyecto...">Loading your project status...</p>
        </div>

        <!-- Main Content (hidden until loaded) -->
        <div id="main-content" style="display: none;">
            <!-- Completed Banner (hidden until complete) -->
            <div class="completed-banner" id="completed-banner" style="display: none;">
                <div class="emoji">üéâ</div>
                <h2 data-en="Your Roof is Complete!" data-es="¬°Su Techo est√° Completo!">Your Roof is Complete!</h2>
                <p data-en="Thank you for choosing Advosy Construction" data-es="Gracias por elegir Advosy Construction">Thank you for choosing Advosy Construction</p>
            </div>

            <!-- Job Info -->
            <div class="job-info">
                <h2 id="customer-name">--</h2>
                <div class="address">
                    <span>üìç</span>
                    <span id="job-address">--</span>
                </div>
                <div class="date">
                    <span data-en="üìÖ Scheduled: " data-es="üìÖ Programado: ">üìÖ Scheduled: </span>
                    <span id="job-date">--</span>
                </div>
            </div>

            <!-- Progress Section -->
            <div class="progress-section">
                <h3 data-en="Installation Progress" data-es="Progreso de Instalaci√≥n">Installation Progress</h3>
                
                <div class="progress-bar-container">
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill" id="progress-fill" style="width: 0%"></div>
                    </div>
                    <div class="progress-percentage" id="progress-percentage">0%</div>
                </div>

                <div class="progress-steps">
                    <div class="progress-step" id="step-arrival">
                        <div class="icon">üè†</div>
                        <div class="content">
                            <div class="name" data-en="Crew Arrived" data-es="Equipo Lleg√≥">Crew Arrived</div>
                            <div class="time" id="time-arrival" data-waiting-en="Waiting..." data-waiting-es="Esperando...">Waiting...</div>
                        </div>
                        <div class="checkmark" style="display: none;">‚úì</div>
                    </div>
                    <div class="progress-step" id="step-tearoff">
                        <div class="icon">üî®</div>
                        <div class="content">
                            <div class="name" data-en="Old Roof Removed" data-es="Techo Viejo Removido">Old Roof Removed</div>
                            <div class="time" id="time-tearoff" data-waiting-en="Waiting..." data-waiting-es="Esperando...">Waiting...</div>
                        </div>
                        <div class="checkmark" style="display: none;">‚úì</div>
                    </div>
                    <div class="progress-step" id="step-underlayment">
                        <div class="icon">üìã</div>
                        <div class="content">
                            <div class="name" data-en="Underlayment Installed" data-es="Base Instalada">Underlayment Installed</div>
                            <div class="time" id="time-underlayment" data-waiting-en="Waiting..." data-waiting-es="Esperando...">Waiting...</div>
                        </div>
                        <div class="checkmark" style="display: none;">‚úì</div>
                    </div>
                    <div class="progress-step" id="step-complete">
                        <div class="icon">‚úÖ</div>
                        <div class="content">
                            <div class="name" data-en="Roof Complete" data-es="Techo Completo">Roof Complete</div>
                            <div class="time" id="time-complete" data-waiting-en="Waiting..." data-waiting-es="Esperando...">Waiting...</div>
                        </div>
                        <div class="checkmark" style="display: none;">‚úì</div>
                    </div>
                </div>
            </div>

            <!-- Photos Section -->
            <div class="photos-section" id="photos-section">
                <h3 data-en="üì∏ Progress Photos" data-es="üì∏ Fotos de Progreso">üì∏ Progress Photos</h3>
                <div class="photos-grid" id="photos-grid">
                    <div class="photo-item">
                        <div class="placeholder" id="photo-arrival">
                            <span>üè†</span>
                            <span data-en="Arrival" data-es="Llegada">Arrival</span>
                        </div>
                    </div>
                    <div class="photo-item">
                        <div class="placeholder" id="photo-tearoff">
                            <span>üî®</span>
                            <span data-en="Tear-Off" data-es="Remoci√≥n">Tear-Off</span>
                        </div>
                    </div>
                    <div class="photo-item">
                        <div class="placeholder" id="photo-underlayment">
                            <span>üìã</span>
                            <span data-en="Underlayment" data-es="Base">Underlayment</span>
                        </div>
                    </div>
                    <div class="photo-item">
                        <div class="placeholder" id="photo-complete">
                            <span>‚úÖ</span>
                            <span data-en="Complete" data-es="Completo">Complete</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contact Section -->
            <div class="contact-section">
                <h3 data-en="Questions about your project?" data-es="¬øPreguntas sobre su proyecto?">Questions about your project?</h3>
                <a href="tel:+16025551234" class="contact-btn">
                    <span data-en="üìû Call Us" data-es="üìû Ll√°menos">üìû Call Us</span>
                </a>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            sheetUrl: 'https://docs.google.com/spreadsheets/d/1msoAfjZr2C8_PcpHL7hn4qv2rzgVPF4EsjAhPaIlcb8/gviz/tq?tqx=out:json&sheet=Jobs'
        };

        let currentLanguage = 'en';

        // Get job_id from URL
        const urlParams = new URLSearchParams(window.location.search);
        const jobId = urlParams.get('job');

        let jobData = null;

        // Language toggle
        function setLanguage(lang) {
            currentLanguage = lang;
            
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase().includes(lang === 'en' ? 'english' : 'espa√±ol'));
            });

            document.querySelectorAll('[data-' + lang + ']').forEach(el => {
                el.textContent = el.getAttribute('data-' + lang);
            });

            // Update waiting text for incomplete steps
            document.querySelectorAll('.progress-step:not(.completed) .time').forEach(el => {
                const waitingText = el.getAttribute('data-waiting-' + lang);
                if (waitingText && !el.dataset.completedTime) {
                    el.textContent = el.classList.contains('current') ? 
                        (lang === 'en' ? 'In progress...' : 'En progreso...') : 
                        waitingText;
                }
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            if (!jobId) {
                document.getElementById('loading-state').innerHTML = '<p>Invalid link. Please use the link from your notification.<br>Enlace inv√°lido. Por favor use el enlace de su notificaci√≥n.</p>';
                return;
            }
            loadJobData();
            // Auto-refresh every 60 seconds
            setInterval(loadJobData, 60000);
        });

        async function loadJobData() {
            try {
                const response = await fetch(CONFIG.sheetUrl);
                const text = await response.text();
                const jsonString = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);?/)[1];
                const data = JSON.parse(jsonString);
                const rows = data.table.rows;
                const cols = data.table.cols.map(c => c.label);

                for (const row of rows) {
                    const rowData = {};
                    row.c.forEach((cell, i) => {
                        if (cell && cell.v !== null) {
                            if (typeof cell.v === 'string' && cell.v.startsWith('Date(')) {
                                const dateMatch = cell.v.match(/Date\((\d+),(\d+),(\d+)\)/);
                                if (dateMatch) {
                                    const year = dateMatch[1];
                                    const month = String(parseInt(dateMatch[2]) + 1).padStart(2, '0');
                                    const day = String(dateMatch[3]).padStart(2, '0');
                                    rowData[cols[i]] = `${year}-${month}-${day}`;
                                } else {
                                    rowData[cols[i]] = cell.v;
                                }
                            } else {
                                rowData[cols[i]] = cell.v;
                            }
                        } else {
                            rowData[cols[i]] = null;
                        }
                    });
                    
                    if (rowData.job_id === jobId) {
                        jobData = rowData;
                        break;
                    }
                }

                if (!jobData) {
                    document.getElementById('loading-state').innerHTML = '<p>Project not found. Please check your link.<br>Proyecto no encontrado. Por favor verifique su enlace.</p>';
                    return;
                }

                displayJobInfo();
                updateProgress();
                
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';

            } catch (error) {
                console.error('Failed to load:', error);
                document.getElementById('loading-state').innerHTML = '<p>Failed to load. Please try again later.<br>Error al cargar. Por favor intente m√°s tarde.</p>';
            }
        }

        function displayJobInfo() {
            document.getElementById('customer-name').textContent = jobData.customer_name || '--';
            document.getElementById('job-address').textContent = (jobData.address || '') + ', ' + (jobData.city || '');
            
            if (jobData.scheduled_date) {
                const date = new Date(jobData.scheduled_date + 'T00:00:00');
                const options = { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' };
                document.getElementById('job-date').textContent = date.toLocaleDateString(currentLanguage === 'es' ? 'es-MX' : 'en-US', options);
            }
        }

        function updateProgress() {
            const steps = [
                { id: 'arrival', field: 'progress_arrival_time', photo: 'progress_arrival_photo' },
                { id: 'tearoff', field: 'progress_tearoff_time', photo: 'progress_tearoff_photo' },
                { id: 'underlayment', field: 'progress_underlayment_time', photo: 'progress_underlayment_photo' },
                { id: 'complete', field: 'progress_complete_time', photo: 'progress_complete_photo' }
            ];

            let completedCount = 0;
            let foundCurrent = false;

            const completedText = currentLanguage === 'es' ? 'Completado a las' : 'Completed at';
            const inProgressText = currentLanguage === 'es' ? 'En progreso...' : 'In progress...';
            const waitingText = currentLanguage === 'es' ? 'Esperando...' : 'Waiting...';

            steps.forEach((step, index) => {
                const stepEl = document.getElementById('step-' + step.id);
                const timeEl = document.getElementById('time-' + step.id);
                const photoEl = document.getElementById('photo-' + step.id);
                const checkmark = stepEl.querySelector('.checkmark');

                if (jobData[step.field]) {
                    completedCount++;
                    stepEl.classList.add('completed');
                    stepEl.classList.remove('current');
                    checkmark.style.display = 'block';
                    
                    const time = new Date(jobData[step.field]);
                    timeEl.textContent = completedText + ' ' + time.toLocaleTimeString(currentLanguage === 'es' ? 'es-MX' : 'en-US', { hour: 'numeric', minute: '2-digit' });
                    timeEl.dataset.completedTime = 'true';
                    
                    // Show photo if available
                    if (jobData[step.photo]) {
                        photoEl.innerHTML = `<img src="${jobData[step.photo]}" alt="${step.id}">`;
                    }
                } else if (!foundCurrent) {
                    stepEl.classList.add('current');
                    stepEl.classList.remove('completed');
                    timeEl.textContent = inProgressText;
                    timeEl.dataset.completedTime = '';
                    foundCurrent = true;
                } else {
                    stepEl.classList.remove('completed', 'current');
                    timeEl.textContent = waitingText;
                    timeEl.dataset.completedTime = '';
                }
            });

            // Update progress bar
            const percentage = Math.round((completedCount / steps.length) * 100);
            document.getElementById('progress-fill').style.width = percentage + '%';
            document.getElementById('progress-percentage').textContent = percentage + '%';

            // Show completed banner if all done
            if (completedCount === steps.length) {
                document.getElementById('completed-banner').style.display = 'block';
            }
        }
    </script>
</body>
</html>
