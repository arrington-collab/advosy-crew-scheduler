<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Accept Job / Aceptar Trabajo - Advosy Construction</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'DM Sans', sans-serif; }
    .mono { font-family: 'JetBrains Mono', monospace; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white">
  
  <!-- Loading State -->
  <div id="loading-state" class="min-h-screen flex items-center justify-center">
    <div class="text-center">
      <div class="w-12 h-12 border-4 border-orange-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
      <p class="text-slate-400">Loading... / Cargando...</p>
    </div>
  </div>

  <!-- Main Content -->
  <div id="main-content" class="hidden min-h-screen p-4 pb-8">
    <!-- Header -->
    <div class="flex items-center gap-3 mb-6">
      <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-red-600 rounded-xl flex items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
        </svg>
      </div>
      <div>
        <h1 class="text-xl font-bold">Advosy Construction</h1>
        <p class="text-slate-400 text-sm">Job Assignment / Asignación de Trabajo</p>
      </div>
    </div>

    <!-- Status Badge -->
    <div id="status-badge" class="mb-6">
      <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-yellow-500/20 border border-yellow-500/50">
        <div class="w-2 h-2 rounded-full bg-yellow-400 animate-pulse"></div>
        <span class="text-yellow-400 font-medium text-sm">
          Awaiting Confirmation / Esperando Confirmación
        </span>
      </div>
    </div>

    <!-- Job Card -->
    <div class="bg-white/5 backdrop-blur-xl rounded-2xl border border-white/10 overflow-hidden mb-6">
      <!-- Customer & Squares -->
      <div class="p-5 border-b border-white/10">
        <div class="flex justify-between items-start">
          <div>
            <h2 class="text-2xl font-bold" id="customer-name">Loading...</h2>
            <p class="text-slate-400 mt-1" id="job-address">Loading address...</p>
          </div>
          <div class="text-right">
            <div class="mono text-3xl font-bold text-orange-400" id="job-squares">--</div>
            <div class="text-slate-500 text-sm">SQUARES / CUADROS</div>
          </div>
        </div>
      </div>

      <!-- Multi-day Schedule Section (shown for multi-day jobs) -->
      <div id="multiday-schedule" class="hidden border-b border-white/10">
        <div class="p-4 bg-blue-500/10">
          <div class="flex items-center gap-2 text-blue-400 mb-3">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            <span class="font-bold">
              Multi-Day Job / Trabajo de Varios Días
            </span>
          </div>
          <div id="day-list" class="space-y-2">
            <!-- Days will be populated here -->
          </div>
        </div>
      </div>

      <!-- Single day date (shown for single-day jobs) -->
      <div id="single-day-section" class="hidden">
        <div class="grid grid-cols-2 gap-px bg-white/10">
          <div class="bg-slate-900/50 p-4">
            <div class="text-slate-500 text-xs uppercase mb-1">
              Date / Fecha
            </div>
            <div class="font-semibold text-lg" id="job-date">--</div>
          </div>
          <div class="bg-slate-900/50 p-4">
            <div class="text-slate-500 text-xs uppercase mb-1">
              Job Type / Tipo de Trabajo
            </div>
            <div class="font-semibold text-lg" id="job-type">--</div>
          </div>
        </div>
      </div>

      <!-- Job Type for multi-day -->
      <div id="multiday-job-type" class="hidden bg-slate-900/50 p-4 border-b border-white/10">
        <div class="text-slate-500 text-xs uppercase mb-1">
          Job Type / Tipo de Trabajo
        </div>
        <div class="font-semibold text-lg" id="job-type-multi">--</div>
      </div>

      <!-- Shingle Info -->
      <div class="grid grid-cols-2 gap-px bg-white/10">
        <div class="bg-slate-900/50 p-4">
          <div class="text-slate-500 text-xs uppercase mb-1">
            Shingle
          </div>
          <div class="font-semibold" id="job-shingle">--</div>
        </div>
        <div class="bg-slate-900/50 p-4">
          <div class="text-slate-500 text-xs uppercase mb-1">
            Color
          </div>
          <div class="font-semibold" id="job-color">--</div>
        </div>
      </div>

      <!-- Flat Section (if applicable) -->
      <div id="flat-section" class="hidden p-4 bg-slate-800/50 border-t border-white/10">
        <div class="text-slate-500 text-xs uppercase mb-1">
          Flat Color / Color Plano
        </div>
        <div class="font-semibold" id="job-flat-color">--</div>
      </div>

      <!-- Material Delivery -->
      <div class="p-4 bg-slate-800/50 border-t border-white/10">
        <div class="text-slate-500 text-xs uppercase mb-1">
          Material Delivery / Entrega de Material
        </div>
        <div class="font-semibold" id="job-delivery">--</div>
      </div>
    </div>

    <!-- Important Notes for Multi-Day -->
    <div id="multiday-notes" class="hidden mb-6 p-4 bg-amber-500/10 border border-amber-500/30 rounded-xl">
      <div class="flex items-start gap-3">
        <svg class="w-6 h-6 text-amber-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <div>
          <p class="text-amber-200 font-medium mb-1">
            Important / Importante
          </p>
          <p class="text-amber-200/80 text-sm">
            By accepting, you commit to ALL days.<br>
            Al aceptar, te comprometes a TODOS los días.
          </p>
        </div>
      </div>
    </div>

    <!-- Accept Button -->
    <div id="action-section" class="space-y-4">
      <button onclick="acceptJob()" id="accept-btn" class="w-full py-4 rounded-2xl bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold text-lg flex items-center justify-center gap-3 shadow-lg shadow-green-500/25 hover:shadow-green-500/40 transition-shadow active:scale-[0.98]">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
        <span>
          Accept Job / Aceptar Trabajo
        </span>
      </button>
      <p class="text-center text-slate-500 text-sm">
        Tap to confirm / Toca para confirmar
      </p>
    </div>

    <!-- Questions? Call PC Section -->
    <div class="mt-8 p-5 bg-white/5 rounded-2xl border border-white/10">
      <div class="text-center mb-4">
        <p class="text-slate-300 font-medium">
          Questions about this job?<br>
          <span class="text-slate-400">¿Preguntas sobre este trabajo?</span>
        </p>
      </div>
      <a id="call-pc-btn" href="tel:+16025551234" class="w-full py-4 rounded-xl bg-blue-500/20 border border-blue-500/50 text-blue-400 font-bold text-lg flex items-center justify-center gap-3 hover:bg-blue-500/30 transition-colors active:scale-[0.98]">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
        </svg>
        <span>
          Call / Llamar: <span id="pc-name">Project Coordinator</span>
        </span>
      </a>
      <p class="text-center text-slate-500 text-sm mt-2" id="pc-phone-display">--</p>
    </div>

    <!-- Can't take job -->
    <div class="mt-6 text-center">
      <button onclick="showDeclineModal()" class="text-slate-400 hover:text-red-400 text-sm underline transition-colors">
        Can't take this job? / ¿No puedes tomar este trabajo?
      </button>
    </div>
  </div>

  <!-- Already Accepted State -->
  <div id="accepted-state" class="hidden min-h-screen flex items-center justify-center p-4">
    <div class="text-center">
      <div class="w-20 h-20 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
        <svg class="w-10 h-10 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
      </div>
      <h2 class="text-2xl font-bold mb-2">
        Job Accepted!<br>
        <span class="text-xl text-slate-300">¡Trabajo Aceptado!</span>
      </h2>
      <p class="text-slate-400 mb-6">
        You're all set. / Todo listo.
      </p>
      <div class="bg-white/5 rounded-xl p-4 text-left max-w-sm mx-auto mb-6">
        <div class="text-sm text-slate-400 mb-1">Job Details / Detalles</div>
        <div class="font-semibold" id="accepted-customer">--</div>
        <div class="text-slate-400 text-sm" id="accepted-date">--</div>
        <div id="accepted-multiday" class="hidden mt-2 text-blue-400 text-sm font-medium"></div>
      </div>
      
      <!-- Call PC from accepted state too -->
      <div class="max-w-sm mx-auto">
        <p class="text-slate-400 text-sm mb-3">
          Questions? / ¿Preguntas?
        </p>
        <a id="call-pc-btn-accepted" href="tel:+16025551234" class="w-full py-3 rounded-xl bg-blue-500/20 border border-blue-500/50 text-blue-400 font-medium flex items-center justify-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
          </svg>
          <span>Call / Llamar: <span id="pc-name-accepted">PC</span></span>
        </a>
      </div>
    </div>
  </div>

  <!-- Error State -->
  <div id="error-state" class="hidden min-h-screen flex items-center justify-center p-4">
    <div class="text-center">
      <div class="w-20 h-20 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
        <svg class="w-10 h-10 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
        </svg>
      </div>
      <h2 class="text-2xl font-bold mb-2">
        Something Went Wrong<br>
        <span class="text-lg font-normal text-slate-400">Algo Salió Mal</span>
      </h2>
      <p class="text-slate-400 mb-6">
        We couldn't load the job.<br>
        No pudimos cargar el trabajo.
      </p>
      <a id="call-pc-btn-error" href="tel:+16025551234" class="inline-flex items-center gap-2 px-6 py-3 rounded-xl bg-orange-500 text-white font-semibold">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
        </svg>
        Call Office / Llamar Oficina
      </a>
    </div>
  </div>

  <!-- Decline Modal -->
  <div id="decline-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="hideDeclineModal()"></div>
    <div class="relative bg-slate-800 rounded-2xl border border-white/10 p-6 w-full max-w-sm">
      <h3 class="text-xl font-bold mb-1">
        Can't Take This Job?<br>
        <span class="text-base font-normal text-slate-400">¿No Puedes Tomar Este Trabajo?</span>
      </h3>
      <p class="text-slate-400 text-sm mb-4">
        Let us know why. / Dinos por qué.
      </p>
      
      <div class="space-y-2 mb-4">
        <label class="flex items-center gap-3 p-3 rounded-xl bg-white/5 cursor-pointer hover:bg-white/10">
          <input type="radio" name="decline-reason" value="schedule" class="w-4 h-4 accent-orange-500">
          <span class="text-sm">Schedule conflict / Conflicto de horario</span>
        </label>
        <label class="flex items-center gap-3 p-3 rounded-xl bg-white/5 cursor-pointer hover:bg-white/10">
          <input type="radio" name="decline-reason" value="location" class="w-4 h-4 accent-orange-500">
          <span class="text-sm">Too far / Muy lejos</span>
        </label>
        <label class="flex items-center gap-3 p-3 rounded-xl bg-white/5 cursor-pointer hover:bg-white/10">
          <input type="radio" name="decline-reason" value="size" class="w-4 h-4 accent-orange-500">
          <span class="text-sm">Job too big/small / Trabajo muy grande/pequeño</span>
        </label>
        <label class="flex items-center gap-3 p-3 rounded-xl bg-white/5 cursor-pointer hover:bg-white/10">
          <input type="radio" name="decline-reason" value="other" class="w-4 h-4 accent-orange-500">
          <span class="text-sm">Other / Otro</span>
        </label>
      </div>
      
      <textarea id="decline-notes" placeholder="Notes (optional) / Notas (opcional)" class="w-full p-3 rounded-xl bg-white/5 border border-white/10 text-white placeholder-slate-500 resize-none mb-4 text-sm" rows="2"></textarea>
      
      <div class="flex gap-3">
        <button onclick="hideDeclineModal()" class="flex-1 py-3 rounded-xl border border-white/20 text-slate-300 font-medium text-sm">
          Cancel / Cancelar
        </button>
        <button onclick="declineJob()" class="flex-1 py-3 rounded-xl bg-red-500 text-white font-semibold text-sm">
          Decline / Rechazar
        </button>
      </div>
    </div>
  </div>

  <!-- Success Animation -->
  <div id="success-overlay" class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-900/95">
    <div class="text-center">
      <div class="w-24 h-24 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-6 animate-bounce">
        <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
        </svg>
      </div>
      <h2 class="text-3xl font-bold mb-2">
        You're On It!<br>
        <span class="text-xl font-normal text-slate-300">¡Estás Listo!</span>
      </h2>
      <p class="text-slate-400 text-lg">
        Job accepted / Trabajo aceptado
      </p>
    </div>
  </div>

  <script>
    // Configuration - Update with your n8n webhook URLs
    const CONFIG = {
      getJobWebhook: 'YOUR_N8N_WEBHOOK_URL/webhook/get-job',
      acceptJobWebhook: 'YOUR_N8N_WEBHOOK_URL/webhook/crew-accept',
      declineJobWebhook: 'YOUR_N8N_WEBHOOK_URL/webhook/crew-decline'
    };

    // Project Coordinators by market
    const PC_INFO = {
      'AZ South': { name: 'Noah Weeks', phone: '520-301-8075' },
      'The Valley': { name: 'Emiliano Tortora', phone: '928-502-9594' },
      'AZ Northwest': { name: 'Marina Jones', phone: '562-922-9093' },
      'Vegas': { name: 'Luisa Rodriguez', phone: '702-963-4848' }
    };

    let jobData = null;
    let allJobDays = [];
    let pcInfo = PC_INFO['The Valley']; // Default

    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const jobId = urlParams.get('id');
    const crewId = urlParams.get('crew');
    const groupId = urlParams.get('group');

    // Demo data - Single day job
    const DEMO_JOB_SINGLE = {
      job_id: 'JOB-1234567890-001-D1',
      job_group_id: 'GRP-1234567890-001',
      customer_name: 'Johnson Family',
      address: '7834 E McDowell Rd',
      city: 'Scottsdale',
      market: 'The Valley',
      squares: 34.5,
      scheduled_date: '2026-01-27',
      delivery_date: '2026-01-26',
      job_type: 'Full Replacement',
      shingle_line: 'IKO Cambridge',
      shingle_color: 'Charcoal',
      flat_color: '',
      day_number: 1,
      total_days: 1,
      status: 'Scheduled',
      sub_accepted: false
    };

    // Demo data - Multi-day job (3 days)
    const DEMO_JOB_MULTI = {
      job_id: 'JOB-9876543210-001-D1',
      job_group_id: 'GRP-9876543210-001',
      customer_name: 'Patel Commercial',
      address: '5500 N 7th Ave',
      city: 'Phoenix',
      market: 'The Valley',
      squares: 85.0,
      scheduled_date: '2026-01-29',
      delivery_date: '2026-01-28',
      job_type: 'Full Replacement',
      shingle_line: 'GAF Timberline',
      shingle_color: 'Pewter Gray',
      flat_color: 'White',
      day_number: 1,
      total_days: 3,
      status: 'Scheduled',
      sub_accepted: false,
      all_days: [
        { day_number: 1, scheduled_date: '2026-01-29' },
        { day_number: 2, scheduled_date: '2026-01-30' },
        { day_number: 3, scheduled_date: '2026-01-31' }
      ]
    };

    // Use multi-day demo if URL has "demo=multi"
    const useMultiDemo = urlParams.get('demo') === 'multi';

    async function loadJob() {
      try {
        if (jobId) {
          const response = await fetch(`${CONFIG.getJobWebhook}?id=${jobId}&crew=${crewId}&group=${groupId || ''}`);
          if (response.ok) {
            const data = await response.json();
            jobData = data.job;
            allJobDays = data.all_days || [];
          } else {
            throw new Error('API error');
          }
        } else {
          // Use demo data
          jobData = useMultiDemo ? DEMO_JOB_MULTI : DEMO_JOB_SINGLE;
          allJobDays = jobData.all_days || [];
        }

        // Set PC info based on market
        if (jobData.market && PC_INFO[jobData.market]) {
          pcInfo = PC_INFO[jobData.market];
        }
        
        updatePCButtons();
        displayJob(jobData);
      } catch (error) {
        console.log('Using demo data');
        jobData = useMultiDemo ? DEMO_JOB_MULTI : DEMO_JOB_SINGLE;
        allJobDays = jobData.all_days || [];
        
        if (jobData.market && PC_INFO[jobData.market]) {
          pcInfo = PC_INFO[jobData.market];
        }
        
        updatePCButtons();
        displayJob(jobData);
      }
    }

    function updatePCButtons() {
      // Update all PC call buttons
      const phoneLink = `tel:+1${pcInfo.phone.replace(/\D/g, '')}`;
      
      document.getElementById('call-pc-btn').href = phoneLink;
      document.getElementById('pc-name').textContent = pcInfo.name;
      document.getElementById('pc-phone-display').textContent = pcInfo.phone;
      
      document.getElementById('call-pc-btn-accepted').href = phoneLink;
      document.getElementById('pc-name-accepted').textContent = pcInfo.name;
      
      document.getElementById('call-pc-btn-error').href = phoneLink;
    }

    function displayJob(job) {
      document.getElementById('loading-state').classList.add('hidden');
      
      // Check if already accepted
      if (job.sub_accepted) {
        showAcceptedState(job);
        return;
      }

      document.getElementById('main-content').classList.remove('hidden');

      // Basic info
      document.getElementById('customer-name').textContent = job.customer_name;
      document.getElementById('job-address').textContent = `${job.address}, ${job.city}`;
      document.getElementById('job-squares').textContent = job.squares;
      document.getElementById('job-shingle').textContent = job.shingle_line || '--';
      document.getElementById('job-color').textContent = job.shingle_color || '--';
      document.getElementById('job-delivery').textContent = job.delivery_date ? formatDate(job.delivery_date) : 'TBD / Por Confirmar';

      // Handle multi-day vs single day display
      if (job.total_days > 1) {
        // Multi-day job
        document.getElementById('multiday-schedule').classList.remove('hidden');
        document.getElementById('multiday-job-type').classList.remove('hidden');
        document.getElementById('multiday-notes').classList.remove('hidden');
        document.getElementById('job-type-multi').textContent = job.job_type;

        // Build day list
        const dayList = document.getElementById('day-list');
        const days = allJobDays.length > 0 ? allJobDays : generateDays(job);
        
        dayList.innerHTML = days.map(day => `
          <div class="flex items-center gap-3 p-3 rounded-lg bg-slate-900/50">
            <div class="w-12 h-12 rounded-lg bg-blue-500/20 flex items-center justify-center flex-shrink-0">
              <span class="font-bold text-blue-400 text-lg">${day.day_number}</span>
            </div>
            <div>
              <div class="font-semibold text-white">
                Day ${day.day_number} of ${job.total_days}
              </div>
              <div class="text-slate-500 text-sm">
                Día ${day.day_number} de ${job.total_days}
              </div>
              <div class="text-orange-400 text-sm font-medium mt-1">${formatDateShort(day.scheduled_date)}</div>
            </div>
          </div>
        `).join('');

      } else {
        // Single day job
        document.getElementById('single-day-section').classList.remove('hidden');
        document.getElementById('job-date').textContent = formatDateShort(job.scheduled_date);
        document.getElementById('job-type').textContent = job.job_type;
      }

      // Flat color
      if (job.flat_color) {
        document.getElementById('flat-section').classList.remove('hidden');
        document.getElementById('job-flat-color').textContent = job.flat_color;
      }
    }

    function generateDays(job) {
      const days = [];
      const startDate = new Date(job.scheduled_date + 'T00:00:00');
      
      for (let i = 0; i < job.total_days; i++) {
        const dayDate = new Date(startDate);
        dayDate.setDate(startDate.getDate() + i);
        
        // Skip Sundays
        if (dayDate.getDay() === 0) {
          dayDate.setDate(dayDate.getDate() + 1);
        }
        
        days.push({
          day_number: i + 1,
          scheduled_date: dayDate.toISOString().split('T')[0]
        });
      }
      
      return days;
    }

    function showAcceptedState(job) {
      document.getElementById('accepted-state').classList.remove('hidden');
      document.getElementById('accepted-customer').textContent = job.customer_name;
      
      if (job.total_days > 1) {
        const days = allJobDays.length > 0 ? allJobDays : generateDays(job);
        const firstDate = formatDateShort(days[0].scheduled_date);
        const lastDate = formatDateShort(days[days.length - 1].scheduled_date);
        document.getElementById('accepted-date').textContent = `${firstDate} → ${lastDate}`;
        document.getElementById('accepted-multiday').classList.remove('hidden');
        document.getElementById('accepted-multiday').textContent = 
          `${job.total_days} days / días • ${job.squares} SQ`;
      } else {
        document.getElementById('accepted-date').textContent = formatDateShort(job.scheduled_date);
      }
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr + 'T00:00:00');
      const en = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
      const es = date.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' });
      return `${en} / ${es}`;
    }

    function formatDateShort(dateStr) {
      const date = new Date(dateStr + 'T00:00:00');
      return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    }

    async function acceptJob() {
      const btn = document.getElementById('accept-btn');
      btn.disabled = true;
      btn.innerHTML = `
        <div class="w-6 h-6 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
        <span>Processing... / Procesando...</span>
      `;

      try {
        const response = await fetch(CONFIG.acceptJobWebhook, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            job_id: jobData.job_id,
            job_group_id: jobData.job_group_id,
            crew_id: crewId || 'CREW-001',
            accepted: true,
            accepted_at: new Date().toISOString(),
            total_days: jobData.total_days
          })
        });

        showSuccessAnimation();
      } catch (error) {
        console.log('Demo mode - job accepted');
        showSuccessAnimation();
      }
    }

    function showSuccessAnimation() {
      const overlay = document.getElementById('success-overlay');
      overlay.classList.remove('hidden');
      overlay.classList.add('flex');

      setTimeout(() => {
        document.getElementById('main-content').classList.add('hidden');
        overlay.classList.add('hidden');
        overlay.classList.remove('flex');
        
        showAcceptedState(jobData);
        document.getElementById('accepted-state').classList.remove('hidden');
      }, 2000);
    }

    function showDeclineModal() {
      const modal = document.getElementById('decline-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function hideDeclineModal() {
      const modal = document.getElementById('decline-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    async function declineJob() {
      const reason = document.querySelector('input[name="decline-reason"]:checked')?.value || 'other';
      const notes = document.getElementById('decline-notes').value;

      try {
        await fetch(CONFIG.declineJobWebhook, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            job_id: jobData.job_id,
            job_group_id: jobData.job_group_id,
            crew_id: crewId || 'CREW-001',
            declined: true,
            reason: reason,
            notes: notes,
            declined_at: new Date().toISOString()
          })
        });
      } catch (error) {
        console.log('Demo mode - decline sent');
      }

      hideDeclineModal();
      
      // Show thank you message
      document.getElementById('main-content').innerHTML = `
        <div class="min-h-screen flex items-center justify-center">
          <div class="text-center">
            <div class="w-16 h-16 bg-slate-700 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
            </div>
            <h2 class="text-xl font-bold mb-2">Thanks for letting us know<br><span class="text-slate-400 font-normal">Gracias por avisarnos</span></h2>
            <p class="text-slate-400 mb-6">We'll reassign this job.<br>Reasignaremos este trabajo.</p>
            <a href="tel:+1${pcInfo.phone.replace(/\D/g, '')}" class="inline-flex items-center gap-2 px-6 py-3 rounded-xl bg-blue-500/20 border border-blue-500/50 text-blue-400 font-medium">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
              </svg>
              Call / Llamar: ${pcInfo.name}
            </a>
          </div>
        </div>
      `;
    }

    // Initialize
    loadJob();
  </script>
</body>
</html>
